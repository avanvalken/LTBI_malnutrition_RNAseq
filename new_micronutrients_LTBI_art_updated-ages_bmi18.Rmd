---
title: "new_micronutrients_LTBI_art_bmi18"
author: "Arthur J. VanValkenburg"
date: "4/24/2019"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    theme: "flatly"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
suppressPackageStartupMessages({
  library(SummarizedExperiment)
  library(edgeR)
  library(sva)
  library(SingleCellExperiment)
  library(singleCellTK)
  library(DESeq2)
  library(TBSignatureProfiler)
  library(DT)
  library(enrichR)
  library(Rtsne)
  library(umap)
  library(ggplot2)
  library(ComplexHeatmap)
  library(tidyverse)
  library(stringi)
  library(hypeR)
  library(knitr)
  library(kableExtra)
  library(readxl)
  library(cutpointr)
  library(readxl)
  library(ggrepel)
})
  
knitr::opts_chunk$set(cache = TRUE)
knitr::opts_chunk$set(echo = FALSE)
#knitr::opts_chunk$set(dev = "svg", dpi = 300)
#  library(reshape2)
#  library(RColorBrewer)
#  library(limma)
#  library(knitr)
#  library(pander)
#  library(xtable)
#})
```

# Loading and processing data
```{r load data, include=FALSE}

#indata is a SingleCellExperiment object
indata <- readRDS("new_indata_SCE.rds")


# correcting colData
df <- read_xlsx("subject_coldata_cc_excel.xlsx")
df <- column_to_rownames(df, var="...1")
# 


#change these to "well"
# relabel <- c( "10200350B")
# 
# df[(match(relabel, df$SUBJID)), "bmi_cat2"] <- "well"
# df[(match(relabel, df$SUBJID)), "status"] <- "LTBI_well"

# change these to "mal"
#  mal_list <- c("10200082A","10200111A")
# # 
# df[(match(mal_list, df$SUBJID)), "bmi_cat2"] <- "mal"
# df[(match(mal_list, df$SUBJID)), "status"] <- "LTBI_mal"



# df$bmi_cat2 <- as.factor(df$bmi_cat2)
# df$status <- as.factor(df$status)
#df$age <- as.numeric(df$age)


 # change colData to updated list (with ages fixed)
#colData(indata) <- DataFrame(df)


#indatalist <- SummarizedExperiment(assays = SimpleList(counts = as.matrix(indatalist$indata2)), colData = DataFrame(indatalist$metadata_added))
#metadata_added = indatalist$metadata_added
#rm(indatalist)


## Removing Outliers
indata <- indata[,-which(colnames(indata) %in% c("10200459B","10200335A","10200332A"))]



# change ages
#colData(indata)$new_age <- df$age

# Want to have 5% present rate
indata <- indata[apply(assay(indata,"counts") != 0, 1, mean)>.2,] 


## Correct some errors in metadata
colData(indata)$Tb_status[grep("074", colnames(indata))] <- "LTBI"
colData(indata)$Tb_status[grep("082", colnames(indata))] <- "LTBI"
colData(indata)$Tb_status[grep("111", colnames(indata))] <- "LTBI"





## Make CPM and log_cpm
#indata  = mkAssay(indata, log = TRUE, counts_to_CPM = TRUE)
#assays(indata)



## rename certain labels
colData(indata)$Tb_status <- factor(gsub("activeTB", "TB", as.character(colData(indata)$Tb_status)))
colData(indata)$bmi_cat2 <- factor(gsub("severely malnourished", "mal", gsub("well nourished", "well", colData(indata)$bmi_cat2)))
colData(indata)$status <- factor(paste(colData(indata)$Tb_status, colData(indata)$bmi_cat2, sep="_"))
table(colData(indata)$status)


colData(indata)$bmi_cat2[grep("082", colnames(indata))] <- factor("mal")
colData(indata)$status[grep("082", colnames(indata))] <- factor("LTBI_mal")

colData(indata)$bmi_cat2[grep("111", colnames(indata))] <- factor("mal")
colData(indata)$status[grep("111", colnames(indata))] <- factor("LTBI_mal")


```

### ComBat Batch correction
```{r corrected data, message=FALSE, results='hide', include = FALSE}

## Make batch variable
batch=rep(1,ncol(indata))
batch[colnames(indata) %in% c("10200247B")]=1
batch[colnames(indata) %in% c("10200227B","10200346A","10200381A","10200308A","10200361A","10200365B","10200467B","10200341A","10200374A", "10200548B","10200343A","10200374B","10200346A","10200377A") ]=1
batch[colnames(indata)%in% c("10200070A", "10200128A","10200056A", "10200075A","10200136A", "10200105A","10200034A","10200058A", "10200007A", "10200064A","10200159A","10200077A","10200073A","10200130A","10200181A","10200059A","10200040B","10200018B","10200065B","10200003B","10200024B","10200004B","10200009B","10200001B","10200057B","10200029B","10200077B","10200035B","10200061B","10200030B","10200063B","10200034B","10200010A","10200288A","10200082A","10200074A","10200060A","10200023A","10200140A","10200111A","10200112A","10200016A","10200015A","10200087A")]=2
colData(indata)$batch <- factor(batch)
rm(batch)

modcombat <- model.matrix(~colData(indata)$bmi_cat2+colData(indata)$Tb_status)

combined_India.combatSeqCorrect <- ComBat_seq(assay(indata, "counts"),
                                      colData(indata)$batch, group=NULL,
                                      covar_mod=modcombat)

assay(indata, "combatseq") <- combined_India.combatSeqCorrect
assays(indata)
indata <- mkAssay(indata, input_name = "combatseq", log = TRUE)

names(assays(indata)) <- c("counts", "combatseq", "log_counts", "counts_cpm", "log_cpm")
rm(modcombat, combined_India.combatSeqCorrect)


```




### Keep only LTBI
```{r filter, include=FALSE}
indata = indata[,colData(indata)$Tb_status=="LTBI"]
dim(indata)
table(colData(indata)$bmi_cat2)
 
```



### Keep only protein coding genes
```{r filter-by-gene-type, include=FALSE}

#indata <- as(indata, "SingleCellExperiment")

prot_code <- indata@rowRanges@elementMetadata
prot_ <- prot_code[which(prot_code$V2 == "protein_coding"),]
prot <- as.character.Array(prot_@listData$V1)

indata = indata[indata@rowRanges@partitioning@NAMES %in% prot,]

rm(prot_, prot_code, prot)
```


# Distribution of data

## Boxplot of age/bmi_cat2
```{r, include=FALSE}

#library(bit64)
df$age <- as.numeric(df$age)
age <- as.numeric(df$age)
names(age) <- (df$SUBJID)


# change to match correct ages to colData
test <- as.data.frame(colData(indata)$SUBJID)
test$ages <- age[match(test$`colData(indata)$SUBJID`, names(age))]

colData(indata)$age <- test$ages

df <- as.data.frame(colData(indata))

boxplot(as.numeric(df$age)~df$bmi_cat2)
```

## Scatterplot of age and BMI
```{r}
#note, NA's are from active TB cases
g <- ggplot(data=df, mapping = aes(age, BMI, color=bmi_cat2)) + 
  geom_point()
g
```

## T-test for age differences
```{r}

mal <- filter(df, bmi_cat2=="mal")
well <- filter(df,bmi_cat2=="well")

t.test(as.numeric(mal$age),as.numeric(well$age))

```

## Subject ID, age, BMI, bmi_cat2
```{r}
truncated_df <- df[,c("SUBJID","age","BMI","bmi_cat2", "status")]

datatable(truncated_df, 
          options=list(scrollX=T,pageLength=50),
          rownames = T)
```



### Make SCE for SCTK {.unlisted, .unnumbered}
```{r sce-for-sctk, echo=FALSE}
indata_SCE = as(indata, "SingleCellExperiment")
#singleCellTK(indata_SCE)
#saveRDS(indata_SCE, file = "indata_SCE.rds")
```


# Dimension Reduction Plots {.tabset}

## PCA  {.tabset}
Using the DESeq object and PCAplot function on the ComBat corrected data


```{r PCA, fig.cap="PCA plot created with the DESeq object and PCAplot function on the Combat-Seq batch corrected data.", fig.height=4, fig.width=4,  echo=FALSE}
#function to plot PCA plot of PC2 and PC3, as PC1 variance appears related to sex differences

plotARTPCA <- function (object, intgroup = "condition", ntop = 500, returnData = FALSE) 
{
    rv <- rowVars(assay(object))
    select <- order(rv, decreasing = TRUE)[seq_len(min(ntop, 
        length(rv)))]
    pca <- prcomp(t(assay(object)[select, ]))
    percentVar <- pca$sdev^2/sum(pca$sdev^2)
    if (!all(intgroup %in% names(colData(object)))) {
        stop("the argument 'intgroup' should specify columns of colData(dds)")
    }
    intgroup.df <- as.data.frame(colData(object)[, intgroup, 
        drop = FALSE])
    group <- if (length(intgroup) > 1) {
        factor(apply(intgroup.df, 1, paste, collapse = ":"))
    }
    else {
        colData(object)[[intgroup]]
    }
    d <- data.frame(PC2 = pca$x[, 2], PC3 = pca$x[, 3], group = group, 
        intgroup.df, name = colnames(object))
    if (returnData) {
        attr(d, "percentVar") <- percentVar[2:3]
        return(d)
    }
    ggplot(data = d, aes_string(x = "PC2", y = "PC3", 
        color = "group")) + geom_point(size = 3) + xlab(paste0("PC2: ", 
        round(percentVar[2] * 100), "% variance")) + ylab(paste0("PC3: ", 
        round(percentVar[3] * 100), "% variance")) + coord_fixed()
}

indata_tmp <- SummarizedExperiment(assays=list(counts=assays(indata)$log_cpm),
                     colData = colData(indata))
#colData(indata_tmp)$sex <- as.factor(colData(indata_tmp)$sex)

plotARTPCA( DESeqTransform(indata_tmp), intgroup = "bmi_cat2")
#plotPCA(DESeqTransform(indata_tmp), intgroup = "sex")
```

## tSNE {.tabset}
```{r tSNE, fig.cap="tSNE_bmi_gradient_plot", fig.height=4, fig.width=4,  echo=FALSE}

assay_type = "log_cpm"

set.seed(1)
tsne_out <- Rtsne(t(assay(indata,assay_type)), check_duplicates = FALSE, pca = TRUE, perplexity=10, theta=0.5, dims=2)

embedding <- as.data.frame(tsne_out$Y)
embedding$Class <- (indata$BMI )


g <- ggplot(embedding, 
            aes(x=V1, y=V2, color=Class), label = colnames(assay(indata,assay_type))) + geom_point(size=1.5) + xlab("T-SNE 1") + ylab("T-SNE 2") + theme(plot.title = element_text(hjust = 0.5)) + 
ggtitle("TSNE Plot") + scale_color_gradient(low="blue", high="red")

plot(g)
```


```{r tSNE2, fig.cap="tSNE", fig.height=4, fig.width=4,  echo=FALSE}
assay_type = "log_cpm"

set.seed(1)
tsne_out <- Rtsne(t(assay(indata,assay_type)), check_duplicates = FALSE, pca = TRUE, perplexity=10, theta=0.5, dims=2)

embedding <- as.data.frame(tsne_out$Y)
embedding$Class <- as.factor(indata$bmi_cat2 )


g <- ggplot(embedding, 
            aes(x=V1, y=V2, color=Class), label = colnames(assay(indata,assay_type))) + geom_point(size=1.5) + xlab("T-SNE 1") + ylab("T-SNE 2") + theme(plot.title = element_text(hjust = 0.5)) + 
ggtitle("TSNE Plot") 

plot(g)
```


## UMAP {.tabset}
```{r UMAP, fig.cap="UMAP", fig.height=4, fig.width=4, echo=FALSE}
assay_type = "log_cpm"

set.seed(1)
umap_out <- umap(t(assay(indata,assay_type)))

embedding <- as.data.frame(umap_out$layout)
embedding$Class <- as.factor(indata$bmi_cat2)

g <- ggplot(embedding, aes(x=V1, y=V2, color=Class, label = colnames(assay(indata,assay_type)))) + geom_point(size=1.5) + xlab("UMAP 1") + ylab("UMAP 2") + theme(plot.title = element_text(hjust = 0.5)) + 
ggtitle("UMAP Plot")

plot(g)
```

## UMAP on PCA data {.tabset}
```{r UMAP-PCA, fig.cap="UMAP of PCA", fig.height=4, fig.width=4, echo=FALSE}


assay_type = "log_cpm"

#df_combat <- as.data.frame(indata_SCE@assays@data@listData[["log_cpm"]])

pca_df <- assay(indata, assay_type)

set.seed(1)

pca_out <- prcomp(t(pca_df))

#plot pca_out

umap_out <- umap(pca_out$x[,1:20])

#pca embedding for pca plot
embedding_pca <- as.data.frame(pca_out$x)
embedding_pca$Class <- as.factor(indata$bmi_cat2)

#pca only
g_pca <- ggplot(embedding_pca, aes(x=pca_out$x[,1],y=pca_out$x[,2], color=Class, label = colnames(assay(indata,assay_type)))) + geom_point(size=1.5) + xlab("PCA 1") + ylab("PCA 2") + theme(plot.title = element_text(hjust = 0.5)) + 
ggtitle("PCA Plot")

#plot(g_pca)

#plotting umap of PCA object (1st 20 principal components)

embedding <- as.data.frame(umap_out$layout)
embedding$Class <- as.factor(indata$bmi_cat2)

g <- ggplot(embedding, aes(x=V1, y=V2, color=Class, label = colnames(assay(indata,assay_type)))) + geom_point(size=1.5) + xlab("UMAP 1") + ylab("UMAP 2") + theme(plot.title = element_text(hjust = 0.5)) + 
ggtitle("UMAP of PCA Plot")

plot(g)


```

# Differential expression, bmi_cat2 {.tabset}
```{r diffex1}

designMat <- model.matrix(~factor(bmi_cat2) , data=colData(indata))

colnames(designMat)
colnames(designMat) <- c("Intercept", "wellnourished")

head(designMat)

fit <- lmFit(assay(indata, "log_cpm"), designMat)

# Difference in expression between malnourished individuals and well-nourished LTBI individuals, among malnourished individuals

contrast.matrixNut<- makeContrasts(wellnourished, levels = designMat)
fitNut <- contrasts.fit(fit,contrast.matrixNut)
fitNut <- eBayes(fitNut)
limmaResNut <- topTable(fitNut, adjust.method = "BH", n = Inf, sort.by = "P")


dim(limmaResNut[limmaResNut$adj.P.Val <0.05,])
table(colData(indata)$bmi_cat2)

new_hist_padjval_100breaks <- hist(limmaResNut$adj.P.Val, breaks=100)
new_hist_pval_100breaks <- hist(limmaResNut$P.Value, breaks=100)
##shows spike near 0

sig_limmaResNut <- limmaResNut[limmaResNut$adj.P.Val <0.1,]
sig_limmaResNut <- sig_limmaResNut[order(sig_limmaResNut$adj.P.Val),]

#write.csv(sig_limmaResNut, "sig_TBgenes_padj.csv")

top_500_genes <- limmaResNut[1:500,]
top_1k_genes <- limmaResNut[1:1000,]
top_3k_genes <- limmaResNut[1:1000,]
top_5k_genes_bmi_cat2 <- limmaResNut[1:5000,]
## top 50 by logfc
###top 50 by p.adj value
top_50 <- sig_limmaResNut[1:50,]
#write.csv(top_50, "top_50_by_padj.csv")


neg_25_log <- (sig_limmaResNut[sig_limmaResNut$logFC < 0,])
neg_25_log <- neg_25_log[order(neg_25_log$logFC),]
neg_25_log <- neg_25_log[1:25,]

#write.csv(neg_25_log, "neg_25_logfc.csv")

top25_lot <- sig_limmaResNut[sig_limmaResNut$logFC >= 0,]
top25_log <- top25_lot[order(-top25_lot$logFC),]
top25_log <- top25_log[1:25,]

#write.csv(top25_log, "top_25_logfc.csv")

```

There are `r nrow(sig_limmaResNut)` significant genes. 


## 2 All genes datatable and heatmap {.tabset}
```{r diffex-datatable-heatmap1}
datatable(sig_limmaResNut, 
          options=list(scrollX=T,pageLength=20),
          rownames = T)

## Make a Heatmap of top 500 genes 
mat = as.matrix(assay(indata[row.names(top_500_genes),],"log_cpm"))
mat = t(scale(t(mat)))
mat = mat[,order(colData(indata)$"BMI")]

df=data.frame(Nutrition=colData(indata)$"bmi_cat2", BMI=(colData(indata)$"BMI")) 

df=df[order(df$BMI),]


ha = HeatmapAnnotation(df = df, col = list(TB_status=c("mal"="Red","well"="Blue")))

Heatmap(mat,show_row_names=T,show_column_names = F, top_annotation = ha, cluster_columns = F )
```


## Volcano plot
```{r}

df <- limmaResNut

df$diffex <- "NO"

df$diffex[df$logFC> 0.1 & df$adj.P.Val<0.1] <- "UP"
df$diffex[df$logFC < -0.1 & df$adj.P.Val<0.1] <- "DN"

df$delabel <- NA

df$SYMBOL <- rownames(df)
thresh <- head(arrange(df, P.Value),20)$P.Value[20]

df$delabel[df$P.Value<=thresh] <- df$SYMBOL

# these are up or down relative to well-nourished LTBI individuals
g <- ggplot(data=df, aes(x=logFC,y=-log10(P.Value), col=diffex,label=delabel )) +
  geom_point()+
  theme_minimal()+
  geom_text_repel()+
  scale_color_manual(values=c("blue", "black", "red"))+
  theme(text = element_text(size=20))

g

#down_genes <- head(arrange(df, P.Value),10)$SYMBOL

# svg("volcanoplot.svg", width=6.5, height = 4)
# g
# dev.off()


```



# SignatureProfiler {.tabset}

## TBSigProfiler TB Pathways {.tabset}
```{r, message=FALSE, results='hide'}
### make a character list of SUBJID from low BMI to Hi BMI

df <- as.data.frame(indata@colData@listData)
order_bmi <- select(df, SUBJID, BMI)
ordered_bmi <- order_bmi[order(order_bmi$BMI),]



## Add new signatures to the profiler
TBsignatures$Zhao_NANO_6 <- c("ANKRD22","ATP1A1","BLK","CCR6","DARS2","EXOC2")

TBsignatures$'CYTO6' <- c("CCL11", "IFNG", "IL15", "IL1B", "IL6", "CXCL10")

TBsignatures$Leong_RISK_29 <- c("SRBD1", "ZNF419", "SH2D1B","CTSA", "GSTA4", "AGAP9", "MOB3C", "WARS1", "LUC7L", "ZNRF1", "CIRBP", "PRSS53", "APOL6", "TCN2", "MDN1", "SNRNP70", "SLC3A1", "NAGA", "SPDYE5",  "SPSB1", "CCDC14",  "IL31RA", "DERA", "FUT4",
"NEIL1",   "ENO3",   "CCDC78", "HM13","ZNF202" )

TBsignatures$Zak_RISK_16 <- c("ANKRD22","APOL1","BATF2" ,"ETV7","FCGR1A", "FCGR1B",  "GBP1","GBP2","GBP4","GBP5", "SCARF1","SEPTIN4", "SERPING1", "STAT1","TAP1","TRAFD1")
TBsignatures$Suliman_RISK_4 <- c("GAS6", "SEPTIN4", "CD1C", "BLK")

TBsignatures$'Leong_RISK_29_up' = c("SPSB1","MOB3C","FUT4","DERA","WARS","ZNRF1","SLC3A1","SRBD1",
                                    "HM13", "CTSA","TCN2", "APOL6","NAGA","IL31RA")
TBsignatures$'Leong_RISK_29_dn' = c("SH2D1B","AGAP9","ZNF202","NEIL1","LUC7L","CCDC78","PRSS53","ENO3",
                                    "CIRBP","SNRNP70","ZNF419","CCDC14","GSTA4","MDN1","SPDYE5")

TBsignatures$generegulators <- c("NONO", "IFNL1", "CKAP2L", "RNY3", "IFNG", "PRL", "FOXM1", "MITF", "IFNA", "GATA1", "TGM2", "TP53", "PGR", "TRPS1", "RC3H1", "IL1RN", "BTK", "IRGM")

#selected tb signatures
samp_tbsignatures <- list(TBsignatures$Suliman_RISK_4, TBsignatures$Sweeney_OD_3, TBsignatures$Leong_RISK_29, TBsignatures$Zak_RISK_16, TBsignatures$Leong_RISK_29_up, TBsignatures$Leong_RISK_29_dn, TBsignatures$Darboe_RISK_11, TBsignatures$generegulators)
names(samp_tbsignatures) <- c("Suliman_RISK_4", "Sweeney_OD_3", "Leong_RISK_29", "Zak_RISK_16", "Leong_RISK_29_up", "Leong_RISK_29_dn", "Darboe_RISK_11", "generegulators")




gsva_res <- runTBsigProfiler(indata, useAssay = "log_cpm", algorithm = "GSVA",
                             signatures = samp_tbsignatures, parallel.sz = 4)
ssgsea_res <- runTBsigProfiler(indata, useAssay = "log_cpm", algorithm = "ssGSEA",
                               signatures = samp_tbsignatures, parallel.sz = 4)

plage_res <- runTBsigProfiler(indata, useAssay = "log_cpm", algorithm = "PLAGE", signatures = samp_tbsignatures, parallel.sz = 4)

```

### GSVA {.tabset}

#### Heatmap

```{r subgsva_a_TBsigs}
signatureHeatmap(gsva_res, name="GSVA", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("bmi_cat2"),
                 showColumnNames = FALSE,
                 split_heatmap='none')
```


#### Boxplot

```{r boxgsva_TBsigs}
signatureBoxplot(gsva_res, name="GSVA", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("bmi_cat2"))# , rotateLabels = TRUE)
```

#### Boxplots Single {.tabset}

```{r , results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(gsva_res,
                         name=i, 
                         signatureColNames = i,
                         annotationColName = c("bmi_cat2"),   
                         rotateLabels = T))

  cat("\n\n")
}

```

#### Signature plots {.tabset}
```{r genes_gsva_TBsigs, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")
#png(filename = paste(i, ".png"))
  signatureGeneHeatmap(gsva_res, useAssay="log_cpm",
                     samp_tbsignatures[[i]],
                     name = i, signatureColNames = NULL,
                     annotationColNames = c("bmi_cat2",i),
                     showColumnNames = FALSE)
#dev.off()
  cat("\n\n")
}

```

#### AUC Table {.tabset}
```{r, message = FALSE}
set.seed(0)
tableAUC(gsva_res,
         annotationColName = "bmi_cat2",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE)
```

#### AUC Boxplots
```{r, message = FALSE}
set.seed(0)
compareBoxplots(gsva_res, annotationColName = "bmi_cat2",
                signatureColNames = names(samp_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
```

#### ROC plots
```{r, message = FALSE, fig.height = 9, fig.width = 12}
signatureROCplot_CI(inputData = gsva_res,
                   signatureColNames = names(samp_tbsignatures),
                   annotationColName = "bmi_cat2")

```

#### Separate ROC plots  {.tabset}

```{r, results = 'asis', message = FALSE}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot_CI(inputData = gsva_res,
                   signatureColNames = i,
                   annotationColName = "bmi_cat2",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}
```


### ssGSEA {.tabset}

#### Heatmap

```{r subssgsea_a_TBsigs}
signatureHeatmap(ssgsea_res, name="ssGSEA", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("bmi_cat2"),
                 showColumnNames = FALSE, scale = TRUE,
                 split_heatmap='none')
```

#### Boxplot

```{r boxssgsea_TBsigs}
signatureBoxplot(ssgsea_res, name="ssGSEA", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("bmi_cat2"), scale = TRUE) #rotateLabels = TRUE,
```

#### Boxplots Single {.tabset}

```{r , results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(ssgsea_res, name=i, signatureColNames = i,
                 annotationColName = c("bmi_cat2"), rotateLabels = T))

  cat("\n\n")
}

```

#### Signature plots {.tabset}
```{r genes_ssgsea_TBsigs, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  signatureGeneHeatmap(ssgsea_res, useAssay="log_cpm",
                     samp_tbsignatures[[i]],
                     name = i, signatureColNames = NULL,
                     annotationColNames = c("bmi_cat2",i),
                     showColumnNames = FALSE, 
                     column_order =  NULL)

  cat("\n\n")
}

```


#### AUC Table
```{r, message = FALSE}
set.seed(0)
tableAUC(ssgsea_res,
         annotationColName = "bmi_cat2",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE)
```

#### AUC Boxplots {.tabset}
```{r ssGSEA-AUC-boxplot, message = FALSE}
set.seed(0)
compareBoxplots(ssgsea_res, annotationColName = "bmi_cat2",
                signatureColNames = names(samp_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
```

#### ROC plots
```{r, message = FALSE, fig.height = 9, fig.width = 12}
signatureROCplot_CI(inputData = ssgsea_res,
                   signatureColNames = names(samp_tbsignatures),
                   annotationColName = "bmi_cat2")

```

#### Separate ROC plots  {.tabset}

```{r, results = 'asis', message = FALSE}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot_CI(inputData = ssgsea_res,
                   signatureColNames = i,
                   annotationColName = "bmi_cat2",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}
```


### PLAGE {.tabset}


#### Heatmap

```{r plage_TBsigs}
signatureHeatmap(plage_res, name="PLAGE", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("bmi_cat2"),
                 showColumnNames = FALSE,
                 split_heatmap='none')
```


#### Boxplot

```{r boxplage_TBsigs}
signatureBoxplot(plage_res, name="PLAGE", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("bmi_cat2"))# , rotateLabels = TRUE)
```

#### Boxplots Single {.tabset}

```{r , results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(plage_res,
                         name=i, 
                         signatureColNames = i,
                         annotationColName = c("bmi_cat2"),   
                         ##violinPlot = TRUE,
                         rotateLabels = T))

  cat("\n\n")
}

```

#### Signature plots {.tabset}
```{r genes_plage_TBsigs, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  signatureGeneHeatmap(plage_res, useAssay="log_cpm",
                     samp_tbsignatures[[i]],
                     name = i, signatureColNames = NULL,
                     annotationColNames = c("bmi_cat2",i),
                     showColumnNames = TRUE, 
                     column_order = ordered_bmi[,1])

  cat("\n\n")
}

```

#### AUC Table {.tabset}
```{r, message = FALSE}
set.seed(0)
tableAUC(plage_res,
         annotationColName = "bmi_cat2",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE)
```

#### AUC Boxplots
```{r, message = FALSE}
set.seed(0)
compareBoxplots(plage_res, annotationColName = "bmi_cat2",
                signatureColNames = names(samp_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
```

#### ROC plots
```{r, message = FALSE, fig.height = 9, fig.width = 12}
signatureROCplot_CI(inputData = plage_res,
                   signatureColNames = names(samp_tbsignatures),
                   annotationColName = "bmi_cat2")

```

#### Separate ROC plots  {.tabset}

```{r, results = 'asis', message = FALSE}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot_CI(inputData = plage_res,
                   signatureColNames = i,
                   annotationColName = "bmi_cat2",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}
```



### Non-normalized Enrichment Scores {.tabset}
```{r, message=FALSE, results='hide'}

# adapted runTBsigProfiler function to return non-normalized ssgsea scores
runTBsigProfiler <- function (input, useAssay = NULL, signatures = NULL, algorithm = c("GSVA", 
                                                                   "ssGSEA", "ASSIGN", "PLAGE", "Zscore", "singscore"), combineSigAndAlgorithm = FALSE, 
          assignDir = NULL, outputFormat = NULL, parallel.sz = 0, ssgsea_norm = TRUE,
          ASSIGNiter = 1e+05, ASSIGNburnin = 50000) 
{
  if (is.null(signatures)) {
    if ("TBsignatures" %in% ls(envir = .GlobalEnv)) {
      get("TBsignatures", envir = .GlobalEnv)
      signatures <- TBsignatures
    }
    else {
      utils::data("TBsignatures", package = "TBSignatureProfiler", 
                  envir = .myenv)
      signatures <- .myenv$TBsignatures
    }
  }
  runindata <- input
  if (methods::is(runindata, "SummarizedExperiment")) {
    if (is.null(useAssay)) {
      if ("counts" %in% names(SummarizedExperiment::assays(input))) {
        useAssay <- "counts"
      }
      else {
        stop("useAssay required for SummarizedExperiment Input")
      }
    }
    runindata <- SummarizedExperiment::assay(input, useAssay)
    if (!combineSigAndAlgorithm & length(algorithm) > 1) {
      stop("SummarizedExperiment not supported with combineSigAndAlgorithm FALSE.")
    }
  }
  else if (!is.null(useAssay)) {
    stop("useAssay only supported for SummarizedExperiment objects")
  }
  if (methods::is(runindata, "data.frame")) {
    runindata <- as.matrix(runindata)
  }
  if (!methods::is(runindata, "matrix")) {
    stop("Invalid input data type. Accepted input formats are matrix, ", 
         "data.frame, or SummarizedExperiment. Your input: ", 
         as.character(class(input)))
  }
  if (!all(algorithm %in% c("GSVA", "ssGSEA", "ASSIGN", "PLAGE", 
                            "Zscore", "singscore"))) {
    stop("Invalid algorithm. Supported algorithms are\n    GSVA, ssGSEA, PLAGE, Zscore, singscore, and ASSIGN")
  }
  gsvaRes <- NULL
  if ("GSVA" %in% algorithm) {
    message("Running GSVA")
    gsvaRes <- GSVA::gsva(runindata, signatures, parallel.sz = parallel.sz)
  }
  gsvaRes_ssgsea <- NULL
  if ("ssGSEA" %in% algorithm) {
    message("Running ssGSEA")
    gsvaRes_ssgsea <- GSVA::gsva(runindata, signatures, 
                                 method = "ssgsea", 
                                 ssgsea.norm=ssgsea_norm,
                                 parallel.sz = parallel.sz)
  }
  gsvaRes_PLAGE <- NULL
  if ("PLAGE" %in% algorithm) {
    message("Running PLAGE")
    gsvaRes_PLAGE <- GSVA::gsva(runindata, signatures, method = "plage", 
                                parallel.sz = parallel.sz)
  }
  gsvaRes_Z <- NULL
  if ("Zscore" %in% algorithm) {
    message("Running Z-score profiling")
    gsvaRes_Z <- GSVA::gsva(runindata, signatures, method = "zscore", 
                            parallel.sz = parallel.sz)
  }
  singscore_res <- NULL
  if ("singscore" %in% algorithm) {
    message("Running singscore")
    singscore_res <- matrix(ncol = ncol(runindata), nrow = length(signatures), 
                            dimnames = list(names(signatures), colnames(runindata)))
    rankDat <- singscore::rankGenes(runindata)
    for (sig in names(signatures)) {
      singscore_res[sig, ] <- suppressWarnings(singscore::simpleScore(rankData = rankDat, 
                                                                      upSet = TBsignatures[[sig]], knownDirection = FALSE)$TotalScore)
    }
  }
  assign_res <- NULL
  if ("ASSIGN" %in% algorithm) {
    delete_intermediate <- FALSE
    if (is.null(assignDir)) {
      assignDir <- tempfile("assign")
      dir.create(assignDir)
      delete_intermediate <- TRUE
    }
    else if (!dir.exists(assignDir)) {
      dir.create(assignDir)
    }
    message("Running ASSIGN")
    for (i in names(signatures)) {
      message(i)
      currlist <- signatures[i]
      currlist[[1]] <- currlist[[1]][currlist[[1]] %in% 
                                       rownames(runindata)]
      if (length(currlist[[1]]) < 2) {
        message("Not enough signature genes in ", i, 
                ",\n                so analysis will not run.")
      }
      else {
        if (!file.exists(i)) {
          ASSIGN::assign.wrapper(testData = runindata, 
                                 trainingLabel = NULL, geneList = currlist, 
                                 adaptive_S = TRUE, iter = ASSIGNiter, burn_in = ASSIGNburnin, 
                                 outputDir = file.path(assignDir, i))
        }
        else {
          message("Result already exists. Delete to re-run.")
        }
      }
    }
    assign_res <- as.matrix(t(ASSIGN::gather_assign_results(assignDir)))
    if (nrow(assign_res) == 0) {
      assign_res <- NULL
    }
    if (delete_intermediate) {
      unlink(assignDir, recursive = TRUE)
    }
    else {
      message("Intermediate ASSIGN results available at ", 
              assignDir)
    }
  }
  sig_result <- NULL
  if (length(algorithm) == 1) {
    if (!is.null(gsvaRes)) {
      sig_result <- gsvaRes
    }
    else if (!is.null(gsvaRes_ssgsea)) {
      sig_result <- gsvaRes_ssgsea
    }
    else if (!is.null(assign_res)) {
      sig_result <- assign_res
    }
    else if (!is.null(gsvaRes_Z)) {
      sig_result <- gsvaRes_Z
    }
    else if (!is.null(gsvaRes_PLAGE)) {
      sig_result <- gsvaRes_PLAGE
    }
    else if (!is.null(singscore_res)) {
      sig_result <- singscore_res
    }
    else {
      stop("ERROR: all valid outputs are empty.")
    }
  }
  else {
    combined_res <- data.frame()
    if (is.null(combineSigAndAlgorithm)) {
      stop("You must choose whether or not to combine the ", 
           "signature and algorithm name using combineSigAndAlgorithm.")
    }
    else if (combineSigAndAlgorithm) {
      if (!is.null(gsvaRes)) {
        rownames(gsvaRes) <- paste("GSVA", rownames(gsvaRes), 
                                   sep = "_")
        combined_res <- gsvaRes
      }
      if (!is.null(gsvaRes_ssgsea)) {
        rownames(gsvaRes_ssgsea) <- paste("ssGSEA", 
                                          rownames(gsvaRes_ssgsea), sep = "_")
        if (nrow(combined_res) == 0) {
          combined_res <- gsvaRes_ssgsea
        }
        else {
          combined_res <- rbind(combined_res, gsvaRes_ssgsea)
        }
      }
      if (!is.null(assign_res)) {
        rownames(assign_res) <- paste("ASSIGN", rownames(assign_res), 
                                      sep = "_")
        if (nrow(combined_res) == 0) {
          combined_res <- assign_res
        }
        else {
          combined_res <- rbind(combined_res, assign_res)
        }
      }
      if (!is.null(gsvaRes_PLAGE)) {
        rownames(gsvaRes_PLAGE) <- paste("PLAGE", rownames(gsvaRes_PLAGE), 
                                         sep = "_")
        if (nrow(combined_res) == 0) {
          combined_res <- gsvaRes_PLAGE
        }
        else {
          combined_res <- rbind(combined_res, gsvaRes_PLAGE)
        }
      }
      if (!is.null(gsvaRes_Z)) {
        rownames(gsvaRes_Z) <- paste("Zscore", rownames(gsvaRes_Z), 
                                     sep = "_")
        if (nrow(combined_res) == 0) {
          combined_res <- gsvaRes_Z
        }
        else {
          combined_res <- rbind(combined_res, gsvaRes_Z)
        }
      }
      if (!is.null(singscore_res)) {
        rownames(singscore_res) <- paste("singscore", 
                                         rownames(singscore_res), sep = "_")
        if (nrow(combined_res) == 0) {
          combined_res <- singscore_res
        }
        else {
          combined_res <- rbind(combined_res, singscore_res)
        }
      }
    }
    else {
      if (!is.null(outputFormat)) {
        if (outputFormat == "SummarizedExperiment") {
          stop("SummarizedExperiment not supported with combineSigAndAlgorithm FALSE.")
        }
      }
      else if (methods::is(input, "SummarizedExperiment")) {
        stop("SummarizedExperiment not supported with combineSigAndAlgorithm FALSE.")
      }
      if (!is.null(gsvaRes)) {
        alg_col <- gsvaRes[, 1, drop = FALSE]
        colnames(alg_col) <- "algorithm"
        alg_col[, 1] <- rep("GSVA", nrow(gsvaRes))
        pathcol <- alg_col
        pathcol[, 1] <- rownames(gsvaRes)
        colnames(pathcol) <- "pathway"
        gsvaRes <- cbind(pathcol, alg_col, gsvaRes)
        combined_res <- gsvaRes
      }
      if (!is.null(gsvaRes_ssgsea)) {
        alg_col <- gsvaRes_ssgsea[, 1, drop = FALSE]
        colnames(alg_col) <- "algorithm"
        alg_col[, 1] <- rep("ssGSEA", nrow(gsvaRes_ssgsea))
        pathcol <- alg_col
        pathcol[, 1] <- rownames(gsvaRes_ssgsea)
        colnames(pathcol) <- "pathway"
        gsvaRes_ssgsea <- cbind(pathcol, alg_col, gsvaRes_ssgsea)
        if (nrow(combined_res) == 0) {
          combined_res <- gsvaRes_ssgsea
        }
        else {
          combined_res <- rbind(combined_res, gsvaRes_ssgsea)
        }
      }
      if (!is.null(assign_res)) {
        alg_col <- assign_res[, 1, drop = FALSE]
        colnames(alg_col) <- "algorithm"
        alg_col[, 1] <- rep("ASSIGN", nrow(assign_res))
        pathcol <- alg_col
        pathcol[, 1] <- rownames(assign_res)
        colnames(pathcol) <- "pathway"
        assign_res <- cbind(pathcol, alg_col, assign_res)
        if (nrow(combined_res) == 0) {
          combined_res <- assign_res
        }
        else {
          combined_res <- rbind(combined_res, assign_res)
        }
      }
      if (!is.null(gsvaRes_PLAGE)) {
        alg_col <- gsvaRes_PLAGE[, 1, drop = FALSE]
        colnames(alg_col) <- "algorithm"
        alg_col[, 1] <- rep("PLAGE", nrow(gsvaRes_PLAGE))
        pathcol <- alg_col
        pathcol[, 1] <- rownames(gsvaRes_PLAGE)
        colnames(pathcol) <- "pathway"
        gsvaRes_PLAGE <- cbind(pathcol, alg_col, gsvaRes_PLAGE)
        if (nrow(combined_res) == 0) {
          combined_res <- gsvaRes_PLAGE
        }
        else {
          combined_res <- rbind(combined_res, gsvaRes_PLAGE)
        }
      }
      if (!is.null(gsvaRes_Z)) {
        alg_col <- gsvaRes_Z[, 1, drop = FALSE]
        colnames(alg_col) <- "algorithm"
        alg_col[, 1] <- rep("Z-Score", nrow(gsvaRes_Z))
        pathcol <- alg_col
        pathcol[, 1] <- rownames(gsvaRes_Z)
        colnames(pathcol) <- "pathway"
        gsvaRes_Z <- cbind(pathcol, alg_col, gsvaRes_Z)
        if (nrow(combined_res) == 0) {
          combined_res <- gsvaRes_Z
        }
        else {
          combined_res <- rbind(combined_res, gsvaRes_Z)
        }
      }
      if (!is.null(singscore_res)) {
        alg_col <- singscore_res[, 1, drop = FALSE]
        colnames(alg_col) <- "algorithm"
        alg_col[, 1] <- rep("singscore", nrow(singscore_res))
        pathcol <- alg_col
        pathcol[, 1] <- rownames(singscore_res)
        colnames(pathcol) <- "pathway"
        singscore_res <- cbind(pathcol, alg_col, singscore_res)
        if (nrow(combined_res) == 0) {
          combined_res <- singscore_res
        }
        else {
          combined_res <- rbind(combined_res, singscore_res)
        }
      }
      rownames(combined_res) <- NULL
    }
    sig_result <- as.matrix(combined_res)
  }
  if (sum(names(signatures) %in% rownames(sig_result)) != 
      length(signatures)) {
    absent <- subset(names(signatures), !(names(signatures) %in% 
                                            rownames(sig_result)))
    if (length(algorithm) == 1) {
      warning(paste("No identifiers in the gene sets could be matched to the identifiers\n          in the expression data for the following signatures: ", 
                    paste(absent, collapse = ", ")))
    }
  }
  if (is.null(outputFormat)) {
    if (class(input)[1] %in% c("SummarizedExperiment", "SingleCellExperiment", 
                               "SCtkExperiment")) {
      SummarizedExperiment::colData(input) <- S4Vectors::cbind(SummarizedExperiment::colData(input), 
                                                               S4Vectors::DataFrame(t(sig_result)))
      return(input)
    }
    else if (methods::is(input, "matrix")) {
      return(sig_result)
    }
    else if (methods::is(input, "data.frame")) {
      dfres <- data.frame(sig_result)
      colnames(dfres) <- colnames(sig_result)
      return(dfres)
    }
  }
  else if (outputFormat == "matrix") {
    return(sig_result)
  }
  else if (outputFormat == "data.frame") {
    dfres <- data.frame(sig_result)
    colnames(dfres) <- colnames(sig_result)
    return(dfres)
  }
  else if (outputFormat == "SummarizedExperiment") {
    attr(rownames(runindata), ".match.hash") <- NULL
    outdata <- SummarizedExperiment::SummarizedExperiment(assays = S4Vectors::SimpleList(data = runindata), 
                                                          colData = S4Vectors::DataFrame(t(sig_result)))
    return(outdata)
  }
  else {
    stop("Output format error.")
  }
}




fold_ssgsea_res <- runTBsigProfiler(indata, useAssay = "log_cpm", algorithm = "ssGSEA",
                               signatures = samp_tbsignatures, parallel.sz = 4, ssgsea_norm = FALSE)


```

### Fold Change
```{r}
zak_fc <- mean(colData(fold_ssgsea_res)$Zak_RISK_16[colData(fold_ssgsea_res)$bmi_cat2 == "mal"])/mean(colData(fold_ssgsea_res)$Zak_RISK_16[colData(fold_ssgsea_res)$bmi_cat2 == "well"])
zak_fc

sweeney_fc <- mean(colData(fold_ssgsea_res)$Sweeney_OD_3[colData(fold_ssgsea_res)$bmi_cat2 == "mal"])/mean(colData(fold_ssgsea_res)$Sweeney_OD_3[colData(fold_ssgsea_res)$bmi_cat2 == "well"])
sweeney_fc

risk4_fc <- mean(colData(fold_ssgsea_res)$Suliman_RISK_4[colData(fold_ssgsea_res)$bmi_cat2 == "mal"])/mean(colData(fold_ssgsea_res)$Suliman_RISK_4[colData(fold_ssgsea_res)$bmi_cat2 == "well"])
risk4_fc

leong_fc <- mean(colData(fold_ssgsea_res)$Leong_RISK_29[colData(fold_ssgsea_res)$bmi_cat2 == "mal"])/mean(colData(fold_ssgsea_res)$Leong_RISK_29[colData(fold_ssgsea_res)$bmi_cat2 == "well"])
leong_fc


leong_fc_up <- mean(colData(fold_ssgsea_res)$Leong_RISK_29_up[colData(fold_ssgsea_res)$bmi_cat2 == "mal"])/mean(colData(fold_ssgsea_res)$Leong_RISK_29_up[colData(fold_ssgsea_res)$bmi_cat2 == "well"])
leong_fc_up

leong_fc_dn <- mean(colData(fold_ssgsea_res)$Leong_RISK_29_dn[colData(fold_ssgsea_res)$bmi_cat2 == "mal"])/mean(colData(fold_ssgsea_res)$Leong_RISK_29_dn[colData(fold_ssgsea_res)$bmi_cat2 == "well"])
leong_fc_dn



```

### Boxplot
```{r non-normalized_boxplot_ssgsea, message=FALSE }
signatureBoxplot(fold_ssgsea_res, name="ssGSEA", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("bmi_cat2"), scale = FALSE) #rotateLabels = TRUE,
```

### Percentiles {.tabset}
### Mal greater than 75 Percentile of well
```{r}
p75_zak <- mean(colData(fold_ssgsea_res)$Zak_RISK_16[colData(fold_ssgsea_res)$bmi_cat2 == "mal"] > quantile(colData(fold_ssgsea_res)$Zak_RISK_16[colData(fold_ssgsea_res)$bmi_cat2 == "well"], .75))

p75_sul <- mean(colData(fold_ssgsea_res)$Suliman_RISK_4[colData(fold_ssgsea_res)$bmi_cat2 == "mal"] > quantile(colData(fold_ssgsea_res)$Suliman_RISK_4[colData(fold_ssgsea_res)$bmi_cat2 == "well"], .75))

p75_Sweeney_OD_3 <- mean(colData(fold_ssgsea_res)$Sweeney_OD_3[colData(fold_ssgsea_res)$bmi_cat2 == "mal"] > quantile(colData(fold_ssgsea_res)$Sweeney_OD_3[colData(fold_ssgsea_res)$bmi_cat2 == "well"], .75))

p75_leong <- mean(colData(fold_ssgsea_res)$Leong_RISK_29[colData(fold_ssgsea_res)$bmi_cat2 == "mal"] > quantile(colData(fold_ssgsea_res)$Leong_RISK_29[colData(fold_ssgsea_res)$bmi_cat2 == "well"], .75))

p75_leong_up <- mean(colData(fold_ssgsea_res)$Leong_RISK_29_up[colData(fold_ssgsea_res)$bmi_cat2 == "mal"] > quantile(colData(fold_ssgsea_res)$Leong_RISK_29_up[colData(fold_ssgsea_res)$bmi_cat2 == "well"], .75))

p75_leong_dn <- mean(colData(fold_ssgsea_res)$Leong_RISK_29_dn[colData(fold_ssgsea_res)$bmi_cat2 == "mal"] > quantile(colData(fold_ssgsea_res)$Leong_RISK_29_dn[colData(fold_ssgsea_res)$bmi_cat2 == "well"], .75))

p75_zak
p75_sul
p75_Sweeney_OD_3
p75_leong
p75_leong_up
p75_leong_dn

df_p75 <- data.frame(cbind(p75_zak, p75_sul, p75_Sweeney_OD_3, p75_leong, p75_leong_up, p75_leong_dn))

datatable(df_p75, 
          options=list(scrollX=T,pageLength=20),
          rownames = T)
```

### Mal greater than 90 Percentile of well
```{r}
p90_zak <- mean(colData(fold_ssgsea_res)$Zak_RISK_16[colData(fold_ssgsea_res)$bmi_cat2 == "mal"] > quantile(colData(fold_ssgsea_res)$Zak_RISK_16[colData(fold_ssgsea_res)$bmi_cat2 == "well"], .90))

p90_sul <- mean(colData(fold_ssgsea_res)$Suliman_RISK_4[colData(fold_ssgsea_res)$bmi_cat2 == "mal"] > quantile(colData(fold_ssgsea_res)$Suliman_RISK_4[colData(fold_ssgsea_res)$bmi_cat2 == "well"], .90))

p90_Sweeney_OD_3 <- mean(colData(fold_ssgsea_res)$Sweeney_OD_3[colData(fold_ssgsea_res)$bmi_cat2 == "mal"] > quantile(colData(fold_ssgsea_res)$Sweeney_OD_3[colData(fold_ssgsea_res)$bmi_cat2 == "well"], .90))

p90_leong <- mean(colData(fold_ssgsea_res)$Leong_RISK_29[colData(fold_ssgsea_res)$bmi_cat2 == "mal"] > quantile(colData(fold_ssgsea_res)$Leong_RISK_29[colData(fold_ssgsea_res)$bmi_cat2 == "well"], .90))


p90_leong_up <- mean(colData(fold_ssgsea_res)$Leong_RISK_29_up[colData(fold_ssgsea_res)$bmi_cat2 == "mal"] > quantile(colData(fold_ssgsea_res)$Leong_RISK_29_up[colData(fold_ssgsea_res)$bmi_cat2 == "well"], .90))

p90_leong_dn <- mean(colData(fold_ssgsea_res)$Leong_RISK_29_dn[colData(fold_ssgsea_res)$bmi_cat2 == "mal"] > quantile(colData(fold_ssgsea_res)$Leong_RISK_29_dn[colData(fold_ssgsea_res)$bmi_cat2 == "well"], .90))

p90_zak
p90_sul
p90_Sweeney_OD_3
p90_leong
p90_leong_up
p90_leong_dn

df_p90 <- data.frame(cbind(p90_zak, p90_sul, p90_Sweeney_OD_3, p90_leong, p90_leong_up, p90_leong_dn))

datatable(df_p90, 
          options=list(scrollX=T,pageLength=20),
          rownames = T)
```

### Youden's index
```{r}

#library(cutpointr)
# calculate the Youden index for each based on ssGSEA scores ROC curve

## dataframe in format for cutpointr package
ssgsea_df <- as.data.frame(colData(fold_ssgsea_res))

#ssgseadf <- as.data.frame(colData(ssgsea_res))

# RISK4 Youden Index
risk4_cp <- cutpointr(ssgsea_df, Suliman_RISK_4, bmi_cat2, 
                method = maximize_metric, metric = youden)

#cp_risk4 <- cutpointr(ssgseadf, Suliman_RISK_4, bmi_cat2, 
#                method = maximize_metric, metric = youden)

# Sweeney3 Youden Index
sweeney3_cp <- cutpointr(ssgsea_df, Sweeney_OD_3, bmi_cat2, 
                method = maximize_metric, metric = youden)

#cp_sweeney3 <- cutpointr(ssgseadf, Sweeney_OD_3, bmi_cat2, 
#                method = maximize_metric, metric = youden)


# PREDICT29 Youden Index
predict29_cp <- cutpointr(ssgsea_df, Leong_RISK_29, bmi_cat2, 
                method = maximize_metric, metric = youden)

# PREDICT29 Youden Index
predict29up_cp <- cutpointr(ssgsea_df, Leong_RISK_29_up, bmi_cat2, 
                method = maximize_metric, metric = youden)

# PREDICT29 Youden Index
predict29dn_cp <- cutpointr(ssgsea_df, Leong_RISK_29_dn, bmi_cat2, 
                method = maximize_metric, metric = youden)

#cp_predict29 <- cutpointr(ssgseadf, Leong_RISK_29, bmi_cat2, 
                #method = maximize_metric, metric = youden)


# ZAK16 Youden Index
zak16_cp <- cutpointr(ssgsea_df, Zak_RISK_16, bmi_cat2, 
                method = maximize_metric, metric = youden)

#cp_zak16 <- cutpointr(ssgseadf, Zak_RISK_16, bmi_cat2, 
                #method = maximize_metric, metric = youden)

# RISK11 Youden Index
risk11_cp <- cutpointr(ssgsea_df, Darboe_RISK_11, bmi_cat2, method = maximize_metric, metric = youden)

cp <- as.data.frame(t(rbind(zak16_cp[,1:13],
                            risk11_cp[,1:13],
                            predict29_cp[,1:13],
                            predict29up_cp[,1:13],
                            predict29dn_cp[,1:13],
                            risk4_cp[,1:13],
                            sweeney3_cp[,1:13])))

colnames(cp) <- c("ZAK16", "RISK11", "PREDICT29", "PREDICT29_up", "PREDICT29_dn", "RISK4", "SWEENEY3")




datatable(cp, 
          options=list(scrollX=T,pageLength=20),
          rownames = T)

```

### correlation between BMI and ssGSEA score
```{r}
rho.Suliman_RISK_4 <- cor.test(ssgsea_df$Suliman_RISK_4 ,ssgsea_df$BMI , method = "spearman", exact = FALSE)

rho.Sweeney_OD_3 <- cor.test(ssgsea_df$Sweeney_OD_3 ,ssgsea_df$BMI , method = "spearman", exact = FALSE)

rho.Leong_RISK_29 <- cor.test(ssgsea_df$Leong_RISK_29 ,ssgsea_df$BMI , method = "spearman", exact = FALSE)

rho.Zak_RISK_16 <- cor.test(ssgsea_df$Zak_RISK_16 ,ssgsea_df$BMI , method = "spearman", exact = FALSE)


rho.Darboe_RISK_11 <- cor.test(ssgsea_df$Darboe_RISK_11 ,ssgsea_df$BMI , method = "spearman", exact = FALSE)


spearman_coef <- as.data.frame(t(rbind(rho.Darboe_RISK_11, 
                               rho.Zak_RISK_16, 
                               rho.Leong_RISK_29, 
                               rho.Suliman_RISK_4,
                               rho.Sweeney_OD_3)))
spearman_coef <-(spearman_coef[c("statistic", "p.value", "estimate"),])
spearman_coef[,1] <- as.numeric(spearman_coef[,1])
spearman_coef[,2] <- as.numeric(spearman_coef[,2])
spearman_coef[,3] <- as.numeric(spearman_coef[,3])
spearman_coef[,4] <- as.numeric(spearman_coef[,4])
spearman_coef[,5] <- as.numeric(spearman_coef[,5])



#write.csv(spearman_coef, "spearman_correlation_coef.csv")

```




## Immune signatures {.tabset}
```{r, message=FALSE, results='hide'}
### make a character list of SUBJID from low BMI to Hi BMI

df <- as.data.frame(indata@colData@listData)
order_bmi <- select(df, SUBJID, BMI)
ordered_bmi <- order_bmi[order(order_bmi$BMI),]



# 
samp_tbsignatures <- readRDS("Immune_signatures.RDS")

samp_tbsignatures2 <- c("GSE26495_NAIVE_VS_PD1HIGH_CD8_TCELL_UP", 
  "GSE26495_NAIVE_VS_PD1LOW_CD8_TCELL_UP",
  "GSE5099_MONOCYTE_VS_CLASSICAL_M1_MACROPHAGE_UP",
  "GSE11057_NAIVE_VS_EFF_MEMORY_CD4_TCELL_UP",
  "GSE11057_NAIVE_VS_MEMORY_CD4_TCELL_UP",
  "GSE6269_E_COLI_VS_STAPH_AUREUS_INF_PBMC_UP",
  "GSE5099_CLASSICAL_M1_VS_ALTERNATIVE_M2_MACROPHAGE_UP",
  "GSE11057_NAIVE_VS_CENT_MEMORY_CD4_TCELL_UP",
  "GSE40274_FOXP3_VS_FOXP3_AND_XBP1_TRANSDUCED_ACTIVATED_CD4_TCELL_UP",
  "GSE32164_RESTING_DIFFERENTIATED_VS_ALTERNATIVELY_ACT_M2_MACROPHAGE_UP",
  "GSE6269_E_COLI_VS_STREP_PNEUMO_INF_PBMC_UP",
  "GSE22886_NAIVE_BCELL_VS_BLOOD_PLASMA_CELL_DN")

names(samp_tbsignatures2) <- c("GSE26495_NAIVE_VS_PD1HIGH_CD8_TCELL_UP", 
  "GSE26495_NAIVE_VS_PD1LOW_CD8_TCELL_UP",
  "GSE5099_MONOCYTE_VS_CLASSICAL_M1_MACROPHAGE_UP",
  "GSE11057_NAIVE_VS_EFF_MEMORY_CD4_TCELL_UP",
  "GSE11057_NAIVE_VS_MEMORY_CD4_TCELL_UP",
  "GSE6269_E_COLI_VS_STAPH_AUREUS_INF_PBMC_UP",
  "GSE5099_CLASSICAL_M1_VS_ALTERNATIVE_M2_MACROPHAGE_UP",
  "GSE11057_NAIVE_VS_CENT_MEMORY_CD4_TCELL_UP",
  "GSE40274_FOXP3_VS_FOXP3_AND_XBP1_TRANSDUCED_ACTIVATED_CD4_TCELL_UP",
  "GSE32164_RESTING_DIFFERENTIATED_VS_ALTERNATIVELY_ACT_M2_MACROPHAGE_UP",
  "GSE6269_E_COLI_VS_STREP_PNEUMO_INF_PBMC_UP",
  "GSE22886_NAIVE_BCELL_VS_BLOOD_PLASMA_CELL_DN")

gsva_res <- runTBsigProfiler(indata, useAssay = "log_cpm", algorithm = "GSVA",
                             signatures = samp_tbsignatures, parallel.sz = 4)
ssgsea_res <- runTBsigProfiler(indata, useAssay = "log_cpm", algorithm = "ssGSEA",
                               signatures = samp_tbsignatures, parallel.sz = 4)

plage_res <- runTBsigProfiler(indata, useAssay = "log_cpm", algorithm = "PLAGE", signatures = samp_tbsignatures, parallel.sz = 4)

```

### GSVA {.tabset}

#### Heatmap

```{r subgsva_a_IMMsigs}
signatureHeatmap(gsva_res, name="GSVA", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("bmi_cat2"),
                 showColumnNames = FALSE,
                 split_heatmap='none')
```


#### Boxplot

```{r boxgsva_IMMsigs}
signatureBoxplot(gsva_res, name="GSVA", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("bmi_cat2"))# , rotateLabels = TRUE)
```

#### Boxplots Single {.tabset}

```{r , results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(gsva_res,
                         name=i, 
                         signatureColNames = i,
                         annotationColName = c("bmi_cat2"),   
                         rotateLabels = T))

  cat("\n\n")
}

```

#### Signature plots {.tabset}
```{r genes_gsva_IMMsigs, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  signatureGeneHeatmap(gsva_res, useAssay="log_cpm",
                     samp_tbsignatures[[i]],
                     name = i, signatureColNames = NULL,
                     annotationColNames = c("bmi_cat2",i),
                     showColumnNames = TRUE, 
                     column_order = ordered_bmi[,1])

  cat("\n\n")
}

```

#### AUC Table {.tabset}
```{r, message = FALSE}
set.seed(0)
tableAUC(gsva_res,
         annotationColName = "bmi_cat2",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE)
```

#### AUC Boxplots
```{r, message = FALSE}
set.seed(0)
compareBoxplots(gsva_res, annotationColName = "bmi_cat2",
                signatureColNames = names(samp_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
```

#### ROC plots
```{r, message = FALSE, fig.height = 9, fig.width = 12}
signatureROCplot_CI(inputData = gsva_res,
                   signatureColNames = names(samp_tbsignatures),
                   annotationColName = "bmi_cat2")

```

#### Separate ROC plots  {.tabset}

```{r, results = 'asis', message = FALSE}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot_CI(inputData = gsva_res,
                   signatureColNames = i,
                   annotationColName = "bmi_cat2",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}
```


### ssGSEA {.tabset}

#### Heatmap

```{r subssgsea_a_IMMsigs}
signatureHeatmap(ssgsea_res, name="ssGSEA", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("bmi_cat2"),
                 showColumnNames = FALSE, scale = TRUE,
                 split_heatmap='none')
```

#### Boxplot

```{r boxssgsea_IMMsigs}

#svg("imm_sig_boxplot.svg", width = 6.5, family = "arial", pointsize = 8)
signatureBoxplot(ssgsea_res, 
                 name="ssGSEA", 
                 signatureColNames = names(samp_tbsignatures2), #only significant imm_sigs
                 annotationColName = c("bmi_cat2"), 
                 scale = TRUE)

#dev.off()


```

#### Boxplots Single {.tabset}

```{r , results="asis"}
for (i in names(samp_tbsignatures2)){

  cat("#####", i, "\n")

  print(signatureBoxplot(ssgsea_res, name=i, signatureColNames = i,
                 annotationColName = c("bmi_cat2"), rotateLabels = T))

  cat("\n\n")
}



```

#### Signature plots {.tabset}
```{r genes_ssgsea_IMMsigs, results="asis"}

for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  signatureGeneHeatmap(ssgsea_res, useAssay="log_cpm",
                     samp_tbsignatures[[i]],
                     name = i, signatureColNames = NULL,
                     annotationColNames = c("bmi_cat2",i),
                     showColumnNames = FALSE, 
                     column_order =  NULL)

  cat("\n\n")
}

```


#### AUC Table
```{r, message = FALSE}
set.seed(0)
tableAUC(ssgsea_res,
         annotationColName = "bmi_cat2",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output="data.frame")
#df <- df[order(df$P.value),]; when df <- data.frame output of tableAUC function

```

#### AUC Boxplots {.tabset}
```{r ssGSEA-AUC-boxplot-IMM, message = FALSE}
set.seed(0)
compareBoxplots(ssgsea_res, annotationColName = "bmi_cat2",
                signatureColNames = names(samp_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
```

#### ROC plots
```{r, message = FALSE, fig.height = 9, fig.width = 12}
signatureROCplot_CI(inputData = ssgsea_res,
                   signatureColNames = names(samp_tbsignatures),
                   annotationColName = "bmi_cat2")

```

#### Separate ROC plots  {.tabset}

```{r, results = 'asis', message = FALSE}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot_CI(inputData = ssgsea_res,
                   signatureColNames = i,
                   annotationColName = "bmi_cat2",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}
```


### PLAGE {.tabset}


#### Heatmap

```{r plage_IMMsigs}
signatureHeatmap(plage_res, name="PLAGE", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("bmi_cat2"),
                 showColumnNames = FALSE,
                 split_heatmap='none')
```


#### Boxplot

```{r boxplage_IMMsigs}
signatureBoxplot(plage_res, name="PLAGE", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("bmi_cat2"))# , rotateLabels = TRUE)
```

#### Boxplots Single {.tabset}

```{r , results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(plage_res,
                         name=i, 
                         signatureColNames = i,
                         annotationColName = c("bmi_cat2"),   
                         ##violinPlot = TRUE,
                         rotateLabels = T))

  cat("\n\n")
}

```

#### Signature plots {.tabset}
```{r genes_plage_IMMsigs, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  signatureGeneHeatmap(plage_res, useAssay="log_cpm",
                     samp_tbsignatures[[i]],
                     name = i, signatureColNames = NULL,
                     annotationColNames = c("bmi_cat2",i),
                     showColumnNames = TRUE, 
                     column_order = ordered_bmi[,1])

  cat("\n\n")
}

```

#### AUC Table {.tabset}
```{r, message = FALSE}
set.seed(0)
tableAUC(plage_res,
         annotationColName = "bmi_cat2",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE)
```

#### AUC Boxplots
```{r, message = FALSE}
set.seed(0)
compareBoxplots(plage_res, annotationColName = "bmi_cat2",
                signatureColNames = names(samp_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
```

#### ROC plots
```{r, message = FALSE, fig.height = 9, fig.width = 12}
signatureROCplot_CI(inputData = plage_res,
                   signatureColNames = names(samp_tbsignatures),
                   annotationColName = "bmi_cat2")

```

#### Separate ROC plots  {.tabset}

```{r, results = 'asis', message = FALSE}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot_CI(inputData = plage_res,
                   signatureColNames = i,
                   annotationColName = "bmi_cat2",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}
```



## Cancer signatures {.tabset}
```{r, message=FALSE, results='hide'}
### make a character list of SUBJID from low BMI to Hi BMI

df <- as.data.frame(indata@colData@listData)
order_bmi <- select(df, SUBJID, BMI)
ordered_bmi <- order_bmi[order(order_bmi$BMI),]



# 
samp_tbsignatures <- readRDS("prCancer_sigs.RDS")



gsva_res <- runTBsigProfiler(indata, useAssay = "log_cpm", algorithm = "GSVA",
                             signatures = samp_tbsignatures, parallel.sz = 4)
ssgsea_res <- runTBsigProfiler(indata, useAssay = "log_cpm", algorithm = "ssGSEA",
                               signatures = samp_tbsignatures, parallel.sz = 4)

plage_res <- runTBsigProfiler(indata, useAssay = "log_cpm", algorithm = "PLAGE", signatures = samp_tbsignatures, parallel.sz = 4)

```

### GSVA {.tabset}

#### Heatmap

```{r subgsva_a_CANCERsigs}
signatureHeatmap(gsva_res, name="GSVA", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("bmi_cat2"),
                 showColumnNames = FALSE,
                 split_heatmap='none')
```


#### Boxplot

```{r boxgsva_CANCERsigs}
signatureBoxplot(gsva_res, name="GSVA", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("bmi_cat2"))# , rotateLabels = TRUE)
```

#### Boxplots Single {.tabset}

```{r , results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(gsva_res,
                         name=i, 
                         signatureColNames = i,
                         annotationColName = c("bmi_cat2"),   
                         rotateLabels = T))

  cat("\n\n")
}

```

#### Signature plots {.tabset}
```{r genes_gsva_CANCERsigs, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  signatureGeneHeatmap(gsva_res, useAssay="log_cpm",
                     samp_tbsignatures[[i]],
                     name = i, signatureColNames = NULL,
                     annotationColNames = c("bmi_cat2",i),
                     showColumnNames = TRUE, 
                     column_order = ordered_bmi[,1])

  cat("\n\n")
}

```

#### AUC Table {.tabset}
```{r, message = FALSE}
set.seed(0)
tableAUC(gsva_res,
         annotationColName = "bmi_cat2",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE)
```

#### AUC Boxplots
```{r, message = FALSE}
set.seed(0)
compareBoxplots(gsva_res, annotationColName = "bmi_cat2",
                signatureColNames = names(samp_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
```

#### ROC plots
```{r, message = FALSE, fig.height = 9, fig.width = 12}
signatureROCplot_CI(inputData = gsva_res,
                   signatureColNames = names(samp_tbsignatures),
                   annotationColName = "bmi_cat2")

```

#### Separate ROC plots  {.tabset}

```{r, results = 'asis', message = FALSE}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot_CI(inputData = gsva_res,
                   signatureColNames = i,
                   annotationColName = "bmi_cat2",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}
```


### ssGSEA {.tabset}

#### Heatmap

```{r subssgsea_a_CANCERsigs}
signatureHeatmap(ssgsea_res, name="ssGSEA", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("bmi_cat2"),
                 showColumnNames = FALSE, scale = TRUE,
                 split_heatmap='none')
```

#### Boxplot

```{r boxssgsea_CANCERsigs}
sig_cancer_sigs <- c("src_up",
                     "bad_250_up",
                     "igfr_75",
                     "e2f3_dn",
                     "krasgv_200_dn",
                     "her2_10_dn",
                     "kraswt_300",
                     "igfr1_100_up",
                     "myc_dn",
                     "myc_up")

# signatureBoxplot(ssgsea_res, name="ssGSEA", signatureColNames = names(samp_tbsignatures),
#                  annotationColName = c("bmi_cat2"), scale = TRUE) #rotateLabels = TRUE,

svg("tb_mal_cancersigs_boxplot_ssgsea.svg", width = 6.5, pointsize = 8, family = "arial")
signatureBoxplot(ssgsea_res, name="ssGSEA", signatureColNames = sig_cancer_sigs,
                 annotationColName = c("bmi_cat2"), scale = TRUE) #rotateLabels = TRUE,
dev.off()

```

#### Boxplots Single {.tabset}

```{r , results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(ssgsea_res, name=i, signatureColNames = i,
                 annotationColName = c("bmi_cat2"), rotateLabels = T))

  cat("\n\n")
}

```

#### Signature plots {.tabset}
```{r genes_ssgsea_CANCERsigs, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  signatureGeneHeatmap(ssgsea_res, useAssay="log_cpm",
                     samp_tbsignatures[[i]],
                     name = i, signatureColNames = NULL,
                     annotationColNames = c("bmi_cat2",i),
                     showColumnNames = FALSE, 
                     column_order =  NULL)

  cat("\n\n")
}

```


#### AUC Table
```{r, message = FALSE}
set.seed(0)
df <- tableAUC(ssgsea_res,
         annotationColName = "bmi_cat2",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")

df <- df[order(df$P.value),]#; when df <- data.frame output of tableAUC function

```

#### AUC Boxplots {.tabset}
```{r ssGSEA-AUC-boxplot-CANCER, message = FALSE}
set.seed(0)
compareBoxplots(ssgsea_res, annotationColName = "bmi_cat2",
                signatureColNames = names(samp_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
```

#### ROC plots
```{r, message = FALSE, fig.height = 9, fig.width = 12}
signatureROCplot_CI(inputData = ssgsea_res,
                   signatureColNames = names(samp_tbsignatures),
                   annotationColName = "bmi_cat2")

```

#### Separate ROC plots  {.tabset}

```{r, results = 'asis', message = FALSE}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot_CI(inputData = ssgsea_res,
                   signatureColNames = i,
                   annotationColName = "bmi_cat2",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}
```


### PLAGE {.tabset}


#### Heatmap

```{r plage_CANCERsigs}
signatureHeatmap(plage_res, name="PLAGE", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("bmi_cat2"),
                 showColumnNames = FALSE,
                 split_heatmap='none')
```


#### Boxplot

```{r boxplage_CANCERsigs}
signatureBoxplot(plage_res, name="PLAGE", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("bmi_cat2"))# , rotateLabels = TRUE)
```

#### Boxplots Single {.tabset}

```{r , results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(plage_res,
                         name=i, 
                         signatureColNames = i,
                         annotationColName = c("bmi_cat2"),   
                         ##violinPlot = TRUE,
                         rotateLabels = T))

  cat("\n\n")
}

```

#### Signature plots {.tabset}
```{r genes_plage_CANCERsigs, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  signatureGeneHeatmap(plage_res, useAssay="log_cpm",
                     samp_tbsignatures[[i]],
                     name = i, signatureColNames = NULL,
                     annotationColNames = c("bmi_cat2",i),
                     showColumnNames = TRUE, 
                     column_order = ordered_bmi[,1])

  cat("\n\n")
}

```

#### AUC Table {.tabset}
```{r, message = FALSE}
set.seed(0)
tableAUC(plage_res,
         annotationColName = "bmi_cat2",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE)
```

#### AUC Boxplots
```{r, message = FALSE}
set.seed(0)
compareBoxplots(plage_res, annotationColName = "bmi_cat2",
                signatureColNames = names(samp_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
```

#### ROC plots
```{r, message = FALSE, fig.height = 9, fig.width = 12}
signatureROCplot_CI(inputData = plage_res,
                   signatureColNames = names(samp_tbsignatures),
                   annotationColName = "bmi_cat2")

```

#### Separate ROC plots  {.tabset}

```{r, results = 'asis', message = FALSE}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot_CI(inputData = plage_res,
                   signatureColNames = i,
                   annotationColName = "bmi_cat2",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}
```




# Session Info
```{r session info}
sessionInfo()
```